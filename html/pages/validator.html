<html>
    <head>
        <title>Helios Node</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="sidebar"></div>

        <div class="main-content" style="display: none">
            <div class="container">
                <div id="validator-form-container"></div>
                
                <div id="validator-info-container" class="validator-grid">
                    <div class="validator-card">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">how_to_reg</i>
                                <span>Validator Information</span>
                            </div>
                        </div>
                        <div id="validator-info">
                            <!-- Les informations du validator seront affichées ici -->
                        </div>
                    </div>
                </div>
    
                <div id="validator-commission-info-container" class="validator-grid">
                    <div class="validator-card">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">account_balance_wallet</i>
                                <span>My Commissions</span>
                            </div>
                        </div>
                        <div id="commissions-info">
                            <!-- Les informations de commission seront affichées ici -->
                        </div>
                    </div>
                </div>
    
                <div id="validator-delegation-info-container" class="validator-grid">
                    <div class="validator-card">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">trending_up</i>
                                <span>My Delegations</span>
                            </div>
                        </div>
                        <div id="delegation-info">
                            <!-- Les informations de délégation seront affichées ici -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <script>
            let password = window.localStorage.getItem("access-code");

            const formatLargeNumber = (value) => {
                if (!value || value === 'N/A') return 'N/A';
                
                const num = parseFloat(value);
                if (isNaN(num)) return value;
                
                if (num >= 1e18) {
                    return (num / 1e18).toFixed(2) + 'e18';
                } else if (num >= 1e15) {
                    return (num / 1e15).toFixed(2) + 'e15';
                } else if (num >= 1e12) {
                    return (num / 1e12).toFixed(2) + 'e12';
                } else if (num >= 1e9) {
                    return (num / 1e9).toFixed(2) + 'e9';
                } else if (num >= 1e6) {
                    return (num / 1e6).toFixed(2) + 'e6';
                } else if (num >= 1e3) {
                    return (num / 1e3).toFixed(2) + 'e3';
                } else {
                    return num.toFixed(2);
                }
            };

            const main = async () => {

                if (password == undefined) {
                    window.location = '/';
                    return ;
                }
                if (!(await isSetup())) {
                    window.location = '/setup';
                    return ;
                }
                displaySideBar();
                document.querySelectorAll('.main-content')[0].style.display = '';

                const validatorAndHisDelegation = await apiGetValidatorAndHisDelegation();

                if (validatorAndHisDelegation == undefined) {
                    console.log('displayCreateValidator')
                    document.getElementById('validator-form-container').style.display = '';
                    document.getElementById('validator-info-container').style.display = 'none';
                    document.getElementById('validator-commission-info-container').style.display = 'none';
                    document.getElementById('validator-delegation-info-container').style.display = 'none';
                    displayCreateValidator();
                } else {
                    document.getElementById('validator-form-container').style.display = 'none';
                    document.getElementById('validator-info-container').style.display = '';
                    document.getElementById('validator-commission-info-container').style.display = '';
                    document.getElementById('validator-delegation-info-container').style.display = '';
                    displayValidatorInfo(validatorAndHisDelegation.validator);
                    displayDelegationInfo(validatorAndHisDelegation.delegation);
                    displayCommissionInfo(validatorAndHisDelegation.commission, validatorAndHisDelegation.validator);
                }
            }

            const unbond = async () => {

            }

            const claim = async () => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                await apiValidatorClaim(walletPassword)
                window.location.reload();
            }

            const claimCommission = async () => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                await apiValidatorClaimCommission(walletPassword)
                window.location.reload();
            }

            const createValidator = async (displayedValidator) => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                await apiValidatorCreate(walletPassword)
                window.location.reload();
            }

            const unjailNode = async (validatorAddress) => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                const result = await apiValidatorUnjail(walletPassword);
                if (result === undefined) {
                    alert("Error unjailing node");
                    return;
                }
                window.location.reload();
            }

            const displayCreateValidator = () => {
                const formHtml = `
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">how_to_reg</i>
                                <span>Create Validator</span>
                            </div>
                        </div>
                            <form id="validator-form">
                                <div class="form-group">
                                    <h3>Commission Rates</h3>
                                    <div class="input-group">
                                        <label for="commission-rate">Rate * (0-1)</label>
                                        <input type="number" 
                                               id="commission-rate" 
                                               name="commission-rate" 
                                               placeholder="Ex: 0.05 for 5%"
                                               min="0"
                                               max="1"
                                               step="0.01"
                                               required>
                                    <small>Initial commission rate (ex: 0.05 for 5%)</small>
                                    </div>

                                    <div class="input-group">
                                        <label for="commission-max-rate">Max Rate * (0-1)</label>
                                        <input type="number" 
                                               id="commission-max-rate" 
                                               name="commission-max-rate" 
                                               placeholder="Ex: 0.20 for 20%"
                                               min="0"
                                               max="1"
                                               step="0.01"
                                               required>
                                    <small>Max rate possible</small>
                                    </div>

                                    <div class="input-group">
                                        <label for="commission-max-change-rate">Max Change Rate * (0-1)</label>
                                        <input type="number" 
                                               id="commission-max-change-rate" 
                                               name="commission-max-change-rate" 
                                               placeholder="Ex: 0.01 for 1%"
                                               min="0"
                                               max="1"
                                               step="0.01"
                                               required>
                                    <small>Max change per update</small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <h3>Validator Settings</h3>
                                    <div class="input-group">
                                        <label for="min-self-delegation">Min Self Delegation * (1 = 1 share)</label>
                                        <input type="number" 
                                               id="min-self-delegation" 
                                               name="min-self-delegation" 
                                               placeholder="Minimum self delegation amount"
                                               min="1"
                                               step="1"
                                               required>
                                    <small>Minimum self delegation amount</small>
                                    </div>
                                </div>

                                <div class="form-group">
                                <button type="submit" class="form-submit">
                                        <i class="material-icons">check</i>
                                        <span>Create Validator</span>
                                    </button>
                                </div>
                            </form>
                    </div>
                `;

                const container = document.getElementById('validator-form-container');
                container.innerHTML = formHtml;

                document.getElementById('validator-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const formData = {
                            commission: {
                                rate: document.getElementById('commission-rate').value,
                                maxRate: document.getElementById('commission-max-rate').value,
                                maxChangeRate: document.getElementById('commission-max-change-rate').value
                            },
                            minSelfDelegation: document.getElementById('min-self-delegation').value,
                            value: "1"
                        };

                        // Validation des données

                        const rate = parseFloat(formData.commission.rate);
                        const maxRate = parseFloat(formData.commission.maxRate);
                        const maxChangeRate = parseFloat(formData.commission.maxChangeRate);

                        if (isNaN(rate) || rate < 0 || rate > 1) {
                            alert("Le taux de commission doit être entre 0 et 1");
                            return;
                        }
                        if (isNaN(maxRate) || maxRate < 0 || maxRate > 1) {
                            alert("Le taux maximum de commission doit être entre 0 et 1");
                            return;
                        }
                        if (isNaN(maxChangeRate) || maxChangeRate < 0 || maxChangeRate > 1) {
                            alert("Le taux de changement maximum doit être entre 0 et 1");
                            return;
                        }
                        if (rate > maxRate) {
                            alert("Le taux de commission ne peut pas être supérieur au taux maximum");
                            return;
                        }

                        const walletPassword = await new Promise((resolve) => {
                            try {
                                pw_prompt({
                                    lm: "Please enter your wallet password:", 
                                    callback: function(password) {
                                        resolve(password);
                                    }
                                });
                            } catch (e) {
                                resolve('');
                            }
                        });

                        if (!walletPassword) {
                            alert("Le mot de passe est requis");
                            return;
                        }

                        const result = await apiValidatorCreate(walletPassword, formData);
                        if (result === undefined) {
                            alert("Erreur lors de la création du validateur");
                            return;
                        }
                        window.location.reload();
                    } catch (error) {
                        console.error("Erreur:", error);
                        alert("Une erreur est survenue lors de la création du validateur: " + error.message);
                    }
                });
            }

            const displayValidatorInfo = (validator) => {
                const validatorInfoDiv = document.getElementById('validator-info');
                
                const statusClass = validator.jailed ? 'danger' : 'highlight';
                const statusText = validator.jailed ? 'Jailed' : 'Active';
                
                validatorInfoDiv.innerHTML = `
                    <div class="validator-stats">
                        <div class="stat-item">
                            <div class="stat-label">APR</div>
                            <div class="stat-value">${validator.apr || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Moniker</div>
                            <div class="stat-value">${validator.moniker || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Status</div>
                            <div class="stat-value ${statusClass}" style="color: ${statusClass == 'highlight' ? '#2ECC71' : '#FFF'}">${statusText}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Min Self Delegation</div>
                            <div class="stat-value">${validator.minSelfDelegation || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Shares</div>
                            <div class="stat-value">${formatLargeNumber(validator.shares)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Rate</div>
                            <div class="stat-value">${validator.commission?.commission_rates?.rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Max Rate</div>
                            <div class="stat-value">${validator.commission?.commission_rates?.max_rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Max Change Rate</div>
                            <div class="stat-value">${validator.commission?.commission_rates?.max_change_rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Update Time</div>
                            <div class="stat-value" style="font-size: 0.875rem;">${validator.commission?.update_time || 'N/A'}</div>
                        </div>
                        <div class="stat-item" style="grid-column: 1 / -1;">
                            <div class="stat-label">Validator Address</div>
                            <div class="stat-value" style="font-size: 0.875rem; word-break: break-all;">${validator.validatorAddress || 'N/A'}</div>
                        </div>
                    </div>
                `;

                if (validator.jailed) {
                    const actionButtons = document.createElement('div');
                    actionButtons.className = 'action-buttons';
                    actionButtons.innerHTML = `
                        <button class="unjail-button" onclick="unjailNode('${validator.validatorAddress}')">
                            <i class="material-icons">restore</i>
                            <span>Unjail Node</span>
                        </button>
                    `;
                    validatorInfoDiv.appendChild(actionButtons);
                }
            }

            const displayDelegationInfo = (delegation) => {
                if (delegation == undefined || delegation.rewards == undefined) {
                    return ;
                }
                const delegationInfoDiv = document.getElementById('delegation-info');
                
                const rewardsAmount = Web3.utils.fromWei(delegation.rewards.amount, 'ether');
                
                let html = `
                    <div class="rewards-section">
                        <div class="rewards-title">
                            <i class="material-icons">redeem</i>
                            Available Rewards
                        </div>
                        <div class="rewards-amount">${rewardsAmount} ${delegation.rewards.denom}</div>
                        <div class="action-buttons">
                            <button id="claim-rewards-btn" class="button primary">
                                <i class="material-icons">redeem</i>
                                <span>Claim Rewards</span>
                            </button>
                    </div>
                    </div>
                `;
                
                if (delegation.assets && delegation.assets.length > 0) {
                    html += `
                        <div style="margin-top: 1.5rem;">
                            <div class="commission-title">
                                <i class="material-icons">account_balance</i>
                                Delegated Assets
                            </div>
                            <ul class="delegation-list">
                    `;
                    delegation.assets.forEach(asset => {
                        const amount = Web3.utils.fromWei(asset.amount, 'ether');
                        html += `
                            <li class="delegation-item">
                                <div>
                                    <div class="delegation-amount">${amount}</div>
                                    <div class="delegation-denom">${asset.denom}</div>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul></div>';
                }
                
                delegationInfoDiv.innerHTML = html;

                const claimBtn = document.getElementById('claim-rewards-btn');
                if (claimBtn) claimBtn.onclick = async () => { await claim(); };
            }

            const displayCommissionInfo = (commission, validator) => {
                if (commission == undefined || commission.amount == undefined) {
                    return ;
                }
                const commissionInfoDiv = document.getElementById('commissions-info');

                const amount = Web3.utils.fromWei(commission.amount, 'ether');
                
                let html = `
                    <div class="commission-section">
                        <div class="commission-title">
                            <i class="material-icons">account_balance_wallet</i>
                            Available Commission
                        </div>
                        <div class="commission-amount">${amount} ${commission.denom}</div>
                        <div class="action-buttons">
                            <button id="claim-commission-btn" class="button primary">
                                <i class="material-icons">redeem</i>
                                <span>Claim Commission</span>
                            </button>
                            <button id="delegate-btn" class="button secondary">
                                <i class="material-icons">open_in_new</i>
                                <span>View on Portal</span>
                            </button>
                    </div>
                    </div>
                `;
                
                commissionInfoDiv.innerHTML = html;

                const claimCommissionBtn = document.getElementById('claim-commission-btn');
                if (claimCommissionBtn) claimCommissionBtn.onclick = async () => { await claimCommission(); };
                const delegateBtn = document.getElementById('delegate-btn');
                if (delegateBtn) delegateBtn.onclick = async () => {
                    window.open(`https://portal.helioschain.network/validators/${validator.validatorAddress}`, '_blank');
                };
            }

            window.addEventListener('DOMContentLoaded', async (event) => {
                await main();
            });

        </script>
        <script src="js/side-bar.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/api.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </body>
</html>
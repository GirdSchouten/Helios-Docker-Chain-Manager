<html>
    <head>
        <title>Helios Node</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="sidebar"></div>

        <div class="main-content" style="display: none">
            <div class="container">
                <div id="validator-form-container"></div>
                
                <div id="validator-info-container" class="validator-grid">
                    <div class="validator-card">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">how_to_reg</i>
                                <span>Validator Information</span>
                            </div>
                        </div>
                        <div id="validator-info">
                            <!-- Les informations du validator seront affichées ici -->
                        </div>
                    </div>
                </div>
    
                <div id="validator-commission-info-container" class="validator-grid">
                    <div class="validator-card">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">account_balance_wallet</i>
                                <span>My Commissions</span>
                            </div>
                        </div>
                        <div id="commissions-info">
                            <!-- Les informations de commission seront affichées ici -->
                        </div>
                    </div>
                </div>

                <div id="validator-assets-info-container" class="validator-grid">
                    <div class="validator-card">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">account_balance</i>
                                <span>My Delegated Assets</span>
                            </div>
                        </div>
                        <div id="assets-info">
                            <!-- Les informations de délégation seront affichées ici -->
                        </div>
                    </div>
                </div>
    
                <div id="validator-delegation-info-container" class="validator-grid">
                    <div class="validator-card">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">trending_up</i>
                                <span>My Delegations</span>
                            </div>
                        </div>
                        <div id="delegations-info">
                            <!-- Les informations de délégation seront affichées ici -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <script>
            let password = window.localStorage.getItem("access-code");

            const formatLargeNumber = (value) => {
                if (!value || value === 'N/A') return 'N/A';
                
                const num = parseFloat(value);
                if (isNaN(num)) return value;
                
                if (num >= 1e18) {
                    return (num / 1e18).toFixed(2) + 'e18';
                } else if (num >= 1e15) {
                    return (num / 1e15).toFixed(2) + 'e15';
                } else if (num >= 1e12) {
                    return (num / 1e12).toFixed(2) + 'e12';
                } else if (num >= 1e9) {
                    return (num / 1e9).toFixed(2) + 'e9';
                } else if (num >= 1e6) {
                    return (num / 1e6).toFixed(2) + 'e6';
                } else if (num >= 1e3) {
                    return (num / 1e3).toFixed(2) + 'e3';
                } else {
                    return num.toFixed(2);
                }
            };

            const main = async () => {

                if (password == undefined) {
                    window.location = '/';
                    return ;
                }
                if (!(await isSetup())) {
                    window.location = '/setup';
                    return ;
                }
                displaySideBar();
                document.querySelectorAll('.main-content')[0].style.display = '';

                const validatorAndHisAssetsAndCommission = await apiGetValidatorAndHisAssetsAndCommission();

                if (validatorAndHisAssetsAndCommission == undefined) {
                    console.log('displayCreateValidator')
                    document.getElementById('validator-form-container').style.display = '';
                    document.getElementById('validator-info-container').style.display = 'none';
                    document.getElementById('validator-commission-info-container').style.display = 'none';
                    document.getElementById('validator-delegation-info-container').style.display = 'none';
                    document.getElementById('validator-assets-info-container').style.display = 'none';
                    displayCreateValidator();
                } else {
                    document.getElementById('validator-form-container').style.display = 'none';
                    document.getElementById('validator-info-container').style.display = '';
                    document.getElementById('validator-commission-info-container').style.display = '';
                    document.getElementById('validator-delegation-info-container').style.display = '';
                    document.getElementById('validator-assets-info-container').style.display = '';
                    displayValidatorInfo(validatorAndHisAssetsAndCommission.validator);
                    // displayDelegationInfo(validatorAndHisDelegation.delegation);
                    displayCommissionInfo(validatorAndHisAssetsAndCommission.commission, validatorAndHisAssetsAndCommission.validator);
                    await displayAssetsInfo(validatorAndHisAssetsAndCommission.assets);


                    const delegations = await apiGetDelegations(validatorAndHisAssetsAndCommission.validator.validatorAddress);

                    if (delegations.length > 0) {
                        await displayDelegationInfo(delegations);
                    }
                }
            }

            const unbond = async () => {

            }

            const claim = async () => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                await apiValidatorClaim(walletPassword)
                window.location.reload();
            }

            const claimCommission = async () => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                await apiValidatorClaimCommission(walletPassword)
                window.location.reload();
            }

            const createValidator = async (displayedValidator) => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                await apiValidatorCreate(walletPassword)
                window.location.reload();
            }

            const unjailNode = async (validatorAddress) => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                const result = await apiValidatorUnjail(walletPassword);
                if (result === undefined) {
                    alert("Error unjailing node");
                    return;
                }
                window.location.reload();
            }

            const displayCreateValidator = () => {
                const formHtml = `
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">how_to_reg</i>
                                <span>Create Validator</span>
                            </div>
                        </div>
                            <form id="validator-form">
                                <div class="form-group">
                                    <h3>Commission Rates</h3>
                                    <div class="input-group">
                                        <label for="commission-rate">Rate * (0-1)</label>
                                        <input type="number" 
                                               id="commission-rate" 
                                               name="commission-rate" 
                                               placeholder="Ex: 0.05 for 5%"
                                               min="0"
                                               max="1"
                                               step="0.01"
                                               required>
                                    <small>Initial commission rate (ex: 0.05 for 5%)</small>
                                    </div>

                                    <div class="input-group">
                                        <label for="commission-max-rate">Max Rate * (0-1)</label>
                                        <input type="number" 
                                               id="commission-max-rate" 
                                               name="commission-max-rate" 
                                               placeholder="Ex: 0.20 for 20%"
                                               min="0"
                                               max="1"
                                               step="0.01"
                                               required>
                                    <small>Max rate possible</small>
                                    </div>

                                    <div class="input-group">
                                        <label for="commission-max-change-rate">Max Change Rate * (0-1)</label>
                                        <input type="number" 
                                               id="commission-max-change-rate" 
                                               name="commission-max-change-rate" 
                                               placeholder="Ex: 0.01 for 1%"
                                               min="0"
                                               max="1"
                                               step="0.01"
                                               required>
                                    <small>Max change per update</small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <h3>Validator Settings</h3>
                                    <div class="input-group">
                                        <label for="min-self-delegation">Min Self Delegation * (1 = 1 share)</label>
                                        <input type="number" 
                                               id="min-self-delegation" 
                                               name="min-self-delegation" 
                                               placeholder="Minimum self delegation amount"
                                               min="1"
                                               step="1"
                                               required>
                                    <small>Minimum self delegation amount</small>
                                    </div>
                                </div>

                                <div class="form-group">
                                <button type="submit" class="form-submit">
                                        <i class="material-icons">check</i>
                                        <span>Create Validator</span>
                                    </button>
                                </div>
                            </form>
                    </div>
                `;

                const container = document.getElementById('validator-form-container');
                container.innerHTML = formHtml;

                document.getElementById('validator-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const formData = {
                            commission: {
                                rate: document.getElementById('commission-rate').value,
                                maxRate: document.getElementById('commission-max-rate').value,
                                maxChangeRate: document.getElementById('commission-max-change-rate').value
                            },
                            minSelfDelegation: document.getElementById('min-self-delegation').value,
                            value: "1"
                        };

                        // Validation des données

                        const rate = parseFloat(formData.commission.rate);
                        const maxRate = parseFloat(formData.commission.maxRate);
                        const maxChangeRate = parseFloat(formData.commission.maxChangeRate);

                        if (isNaN(rate) || rate < 0 || rate > 1) {
                            alert("Le taux de commission doit être entre 0 et 1");
                            return;
                        }
                        if (isNaN(maxRate) || maxRate < 0 || maxRate > 1) {
                            alert("Le taux maximum de commission doit être entre 0 et 1");
                            return;
                        }
                        if (isNaN(maxChangeRate) || maxChangeRate < 0 || maxChangeRate > 1) {
                            alert("Le taux de changement maximum doit être entre 0 et 1");
                            return;
                        }
                        if (rate > maxRate) {
                            alert("Le taux de commission ne peut pas être supérieur au taux maximum");
                            return;
                        }

                        const walletPassword = await new Promise((resolve) => {
                            try {
                                pw_prompt({
                                    lm: "Please enter your wallet password:", 
                                    callback: function(password) {
                                        resolve(password);
                                    }
                                });
                            } catch (e) {
                                resolve('');
                            }
                        });

                        if (!walletPassword) {
                            alert("Le mot de passe est requis");
                            return;
                        }

                        const result = await apiValidatorCreate(walletPassword, formData);
                        if (result === undefined) {
                            alert("Erreur lors de la création du validateur");
                            return;
                        }
                        window.location.reload();
                    } catch (error) {
                        console.error("Erreur:", error);
                        alert("Une erreur est survenue lors de la création du validateur: " + error.message);
                    }
                });
            }

            const displayValidatorInfo = (validator) => {
                const validatorInfoDiv = document.getElementById('validator-info');
                
                const statusClass = validator.jailed ? 'danger' : 'highlight';
                const statusText = validator.jailed ? 'Jailed' : 'Active';
                
                validatorInfoDiv.innerHTML = `
                    <div class="validator-stats">
                        <div class="stat-item">
                            <div class="stat-label">APR</div>
                            <div class="stat-value">${validator.apr || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Moniker</div>
                            <div class="stat-value">${validator.moniker || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Status</div>
                            <div class="stat-value ${statusClass}" style="color: ${statusClass == 'highlight' ? '#2ECC71' : '#FFF'}">${statusText}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Min Self Delegation</div>
                            <div class="stat-value">${validator.minSelfDelegation || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Shares</div>
                            <div class="stat-value">${Web3.utils.fromWei(validator.shares.split('.')[0], 'ether')}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Rate</div>
                            <div class="stat-value">${validator.commission?.commission_rates?.rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Max Rate</div>
                            <div class="stat-value">${validator.commission?.commission_rates?.max_rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Max Change Rate</div>
                            <div class="stat-value">${validator.commission?.commission_rates?.max_change_rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Update Time</div>
                            <div class="stat-value" style="font-size: 0.875rem;">${validator.commission?.update_time || 'N/A'}</div>
                        </div>
                        <div class="stat-item" style="grid-column: 1 / -1;">
                            <div class="stat-label">Validator Address</div>
                            <div class="stat-value" style="font-size: 0.875rem; word-break: break-all;">${validator.validatorAddress || 'N/A'}</div>
                        </div>
                    </div>
                `;

                if (validator.jailed) {
                    const actionButtons = document.createElement('div');
                    actionButtons.className = 'action-buttons';
                    actionButtons.innerHTML = `
                        <button class="unjail-button" onclick="unjailNode('${validator.validatorAddress}')">
                            <i class="material-icons">restore</i>
                            <span>Unjail Node</span>
                        </button>
                    `;
                    validatorInfoDiv.appendChild(actionButtons);
                }
            }

            const displayDelegationInfo = async (delegations) => {
                if (delegations == undefined || delegations.length == 0) {
                    return ;
                }

                const delegationsInfoDiv = document.getElementById('delegations-info');
                let html = ``;

                const promises = delegations.map(async (delegation) => {
                    const rewardsAmount = Web3.utils.fromWei(delegation.rewards.amount, 'ether');
                    const rewardsDenom = delegation.rewards.denom;
                    const validatorAddress = delegation.validatorAddress;

                    console.log(delegation.validatorAddress);

                    let htmlOfDelegation = ``;
                    // create one div for each validator address
                    htmlOfDelegation += `
                        <div class="rewards-section">
                            <div class="rewards-title">
                                <i class="material-icons">account_balance</i>
                                ${delegation.validatorAddress}
                            </div>
                    `;

                    htmlOfDelegation += `
                        <div class="rewards-section">
                            <div class="rewards-title">
                                <i class="material-icons">redeem</i>
                                Available Rewards
                            </div>
                            <div class="rewards-amount">${rewardsAmount} ${rewardsDenom}</div>
                            <div class="action-buttons">
                                <button id="claim-rewards-btn" class="button primary">
                                    <i class="material-icons">redeem</i>
                                    <span>Claim Rewards</span>
                                </button>
                            </div>
                        </div>
                    `;

                                         if (delegation.assets && delegation.assets.length > 0) {
                         htmlOfDelegation += `
                             <div style="margin-top: 1.5rem;">
                                 <div class="commission-title">
                                     <i class="material-icons">account_balance</i>
                                     Delegated Assets
                                 </div>
                                 <div class="delegations-table-container">
                                     <table class="delegations-table">
                                         <thead>
                                             <tr>
                                                 <th>Amount</th>
                                                 <th>Symbol</th>
                                                 <th>Contract Address</th>
                                                 <th>Origin Blockchain ID</th>
                                                 <th>Actions</th>
                                             </tr>
                                         </thead>
                                         <tbody>
                         `;
                         
                         for (const asset of delegation.assets) {
                             const amountSplitted = asset.amount.split('.');
                             const amount = Web3.utils.fromWei(amountSplitted[0], 'ether');
                             const tokenDetails = await getTokenDetails(asset.denom);

                             const symbol = tokenDetails?.metadata?.symbol || asset.denom;
                             let originBlockchainId = '42000';

                             if (tokenDetails?.metadata?.chainsMetadatas != undefined) {
                                 const chainsMetadatas = tokenDetails?.metadata?.chainsMetadatas;
                                 originBlockchainId = chainsMetadatas.find(chain => chain.isOriginated)?.chainId || 'N/A';
                             }

                             let contractAddress = asset.denom;
                             if (tokenDetails?.metadata?.contract_address != undefined) {
                                contractAddress = tokenDetails?.metadata?.contract_address;
                             }

                             htmlOfDelegation += `
                                 <tr>
                                     <td class="amount-cell">${amount}</td>
                                     <td class="symbol-cell">${symbol}</td>
                                     <td class="contract-cell">${contractAddress}</td>
                                     <td class="origin-cell">${originBlockchainId}</td>
                                     <td class="actions-cell">
                                         <!--- <button class="button tertiary small" onclick="undelegate('${delegation.validatorAddress}', '${asset.denom}')" title="Undelegate">
                                             <span class="material-icons">remove_circle</span>
                                         </button>
                                         <button class="button tertiary small" onclick="delegate('${delegation.validatorAddress}', '${asset.denom}')" title="Delegate">
                                             <span class="material-icons">add_circle</span>
                                         </button> -->
                                     </td>
                                 </tr>
                             `;
                         };
                         
                         htmlOfDelegation += '</tbody></table></div>';
                     }

                    htmlOfDelegation += `
                        </div>
                    `;
                    return htmlOfDelegation;
                });

                const rows = await Promise.all(promises);
                html += rows.join('');

                delegationsInfoDiv.innerHTML = html;

                const claimBtn = document.getElementById('claim-rewards-btn');
                if (claimBtn) claimBtn.onclick = async () => { await claim(); };
            }

            const displayAssetsInfo = async (assets) => {
                if (assets == undefined || assets.length == 0) {
                    return ;
                }
                const assetsInfoDiv = document.getElementById('assets-info');

                let html = ``;

                if (assets.length > 0) {
                    html += `
                        <div style="margin-top: 1.5rem;">
                            <div class="commission-title">
                                <i class="material-icons">account_balance</i>
                                Delegated Assets
                            </div>
                            <div class="assets-table-container">
                                <table class="assets-table">
                                    <thead>
                                        <tr>
                                            <th>Amount</th>
                                            <th style="color: #FFF;">Symbol</th>
                                            <th>Contract Address</th>
                                            <th>Origin Blockchain ID</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    const promises = assets.map(async (asset) => {
                        const amount = Web3.utils.fromWei(asset.baseAmount, 'ether');
                        const contractAddress = asset.contractAddress;
                        const tokenDetails = await getTokenDetails(contractAddress);

                        const symbol = tokenDetails?.metadata?.symbol || 'N/A';
                        let originBlockchainId = '42000';

                        if (tokenDetails?.metadata?.chainsMetadatas != undefined) {
                            const chainsMetadatas = tokenDetails?.metadata?.chainsMetadatas;
                            originBlockchainId = chainsMetadatas.find(chain => chain.isOriginated)?.chainId || 'N/A';
                        }

                        return `
                            <tr>
                                <td class="amount-cell">${amount}</td>
                                <td class="symbol-cell">${symbol}</td>
                                <td class="contract-cell">${contractAddress}</td>
                                <td class="origin-cell">${originBlockchainId}</td>
                            </tr>
                        `;
                    });
                    
                    const rows = await Promise.all(promises);
                    html += rows.join('') + '</tbody></table></div>';
                }

                assetsInfoDiv.innerHTML = html;
                console.log(assets);
            }

            const getTokenDetails = async (contractAddress) => {
                try {
                    if (window.localStorage.getItem(contractAddress) != undefined) {
                        return JSON.parse(window.localStorage.getItem(contractAddress));
                    }
                    if (!contractAddress.startsWith('0x')) {
                        return undefined;
                    }
                    const tokenDetails = await apiGetTokenDetails(contractAddress);

                    if (tokenDetails != undefined && tokenDetails !== false) {
                        window.localStorage.setItem(contractAddress, JSON.stringify(tokenDetails));
                        if (tokenDetails.metadata?.base != undefined) {
                            window.localStorage.setItem(tokenDetails.metadata.base, JSON.stringify(tokenDetails));
                        }
                    }
                    return tokenDetails;
                } catch (e) {
                    console.log(e);
                    return undefined;
                }
            }

            const undelegate = async (validatorAddress, denom) => {
                if (confirm(`Are you sure you want to undelegate from validator ${validatorAddress}?\n\nDenom: ${denom}`)) {
                    try {
                        // TODO: Implement undelegate API call
                        console.log('Undelegating:', { validatorAddress, denom });
                        alert('Undelegate functionality will be implemented soon');
                    } catch (error) {
                        console.error('Error undelegating:', error);
                        alert('Error undelegating: ' + error.message);
                    }
                }
            }

            const delegate = async (validatorAddress, denom) => {
                try {
                    const newValidatorAddress = prompt('Enter the new validator address to redelegate to:');
                    if (newValidatorAddress && newValidatorAddress.trim()) {
                        if (confirm(`Are you sure you want to delegate to ${newValidatorAddress}?\n\nDenom: ${denom}`)) {
                            // TODO: Implement delegate API call
                            console.log('Delegating:', { 
                                fromValidator: validatorAddress, 
                                toValidator: newValidatorAddress, 
                                denom 
                            });
                            alert('Redelegate functionality will be implemented soon');
                        }
                    }
                } catch (error) {
                    console.error('Error redelegating:', error);
                    alert('Error redelegating: ' + error.message);
                }
            }

            const displayCommissionInfo = (commission, validator) => {
                if (commission == undefined || commission.amount == undefined) {
                    return ;
                }
                const commissionInfoDiv = document.getElementById('commissions-info');

                const amount = Web3.utils.fromWei(commission.amount, 'ether');
                
                let html = `
                    <div class="commission-section">
                        <div class="commission-title">
                            <i class="material-icons">account_balance_wallet</i>
                            Available Commission
                        </div>
                        <div class="commission-amount">${amount} ${commission.denom}</div>
                        <div class="action-buttons">
                            <button id="claim-commission-btn" class="button primary">
                                <i class="material-icons">redeem</i>
                                <span>Claim Commission</span>
                            </button>
                            <button id="delegate-btn" class="button secondary">
                                <i class="material-icons">open_in_new</i>
                                <span>View on Portal</span>
                            </button>
                    </div>
                    </div>
                `;
                
                commissionInfoDiv.innerHTML = html;

                const claimCommissionBtn = document.getElementById('claim-commission-btn');
                if (claimCommissionBtn) claimCommissionBtn.onclick = async () => { await claimCommission(); };
                const delegateBtn = document.getElementById('delegate-btn');
                if (delegateBtn) delegateBtn.onclick = async () => {
                    window.open(`https://portal.helioschain.network/validators/${validator.validatorAddress}`, '_blank');
                };
            }

            window.addEventListener('DOMContentLoaded', async (event) => {
                await main();
            });

        </script>
        <script src="js/theme.js"></script>
        <script src="js/side-bar.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/api.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </body>
</html>
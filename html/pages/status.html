<html>
    <head>
        <title>Helios Node</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
        <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="sidebar">
            <div class="sidebar-logo">
                <img src="./logo.png" alt="Logo">
            </div>
            <div class="sidebar-logo-mobile">
                <img src="./icon.png" alt="Logo">
            </div>
            <a href="status" class="sidebar-button" title="Home">
                <i class="material-icons">home</i>
                <span>Node</span>
            </a>
            <a href="validator" class="sidebar-button mt-1" title="Validator">
                <i class="material-icons">how_to_reg</i>
                <span>Validator</span>
            </a>
            <a href="settings" class="sidebar-button mt-1" title="Settings">
                <i class="material-icons">settings</i>
                <span>Settings</span>
            </a>
            <a href="eth-stats" class="sidebar-button mt-1" title="EthStats">
                <i class="material-icons">analytics</i>
                <span>EthStats</span>
            </a>
            <a href="hyperions" class="sidebar-button mt-1" title="Hyperions">
                <i class="material-icons">blur_on</i>
                <span>Hyperions</span>
            </a>
            <a href="ibc-relayers" class="sidebar-button mt-1" title="IBC Relayers">
                <i class="material-icons">multiple_stop</i>
                <span>IBC Relayers</span>
            </a>
        </div>

        <div class="main-content" style="display: none">
            <div class="container">
                <div class="grid-container-one">
                    <div class="section">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="material-icons">account_tree</i>
                                <span>Node Status</span>
                            </div>
                            <div id="node1-status" class="status-badge inactive">
                                <i class="material-icons">fiber_manual_record</i>
                                <span>Inactive</span>
                            </div>
                        </div>
                        
                        <div class="section-content">
                            <!-- <div class="form-group">
                                <label for="node1-keystore-password">Wallet Password</label>
                                <input id="node1-keystore-password" 
                                       type="password" 
                                       class="form-control" 
                                       placeholder="Enter your wallet password">
                            </div> -->

                            <div class="button-group grp3">
                                <button id="node1-button-start" class="button primary" onclick="startNode1(this)">
                                    <i class="material-icons">play_arrow</i>
                                    <span>Start</span>
                                </button>
                                <button id="node1-button-stop" class="button secondary" onclick="stopNode1(this)">
                                    <i class="material-icons">stop</i>
                                    <span>Stop</span>
                                </button>
                                <button id="node1-button-restart" class="button warning" onclick="restartNode1(this)">
                                    <i class="material-icons">autorenew</i>
                                    <span>Restart</span>
                                </button>                                
                            </div>
                        </div>
                    </div>

                    <div class="section logs-section">
                        <div class="section-title">
                            <i class="material-icons">terminal</i>
                            <span>Node Logs</span>
                        </div>
                        <div class="logs-container">
                            <pre id="node1-logs"></pre>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <script>
            let password = window.localStorage.getItem("access-code");

            // lib
            const rot13 = str => str.split('')
                    .map(char => String.fromCharCode(char.charCodeAt(0) + 13))
                    .join('');

            function compareIt(a,b){
                let ap = a.trim().replace(/\&lt/gm, '<').replace(/\&gt/gm, '<').replace(/[^a-z0-9]/gi, '');
                let bp = b.trim().replace(/\&lt/gm, '<').replace(/\&gt/gm, '<').replace(/[^a-z0-9]/gi, '');
                let cmp = ap != bp;
                return cmp;
            }

            function scrollLogToBottom(element) {
                element.scrollTop = element.scrollHeight;
            }

            async function updateDisplay(jsonData) {

                let node1Status = document.getElementById('node1-status');
                let node1Logs = document.getElementById('node1-logs');
                let node1ButtonStart = document.getElementById('node1-button-start');
                let node1ButtonStop = document.getElementById('node1-button-stop');

                node1Status.innerText = jsonData.node.status == '1' ? 'Active' : 'Inactive';
                if (compareIt(node1Logs.innerHTML, jsonData.node.logs.join('\n'))) {
                    node1Logs.innerHTML = jsonData.node.logs.join('\n');
                    scrollLogToBottom(node1Logs);
                }
                node1ButtonStart.disabled = jsonData.node.status == '1';
                node1ButtonStop.disabled = jsonData.node.status == '0';

                // let ethStatsButtonStart = document.getElementById('ethStats-button-start');
                // let ethStatsButtonStop = document.getElementById('ethStats-button-stop');

                // if (jsonData.ethStats?.status == '1') {
                //     ethStatsButtonStart.disabled = true;
                //     ethStatsButtonStop.disabled = false;
                // } else {
                //     ethStatsButtonStart.disabled = false;
                //     ethStatsButtonStop.disabled = true;
                // }

                // let inputEthStatsServerUrl = document.getElementById('ethStats-server-url');
                // if (window.localStorage.getItem('ethstats-server-url') != inputEthStatsServerUrl.value) {
                //     window.localStorage.setItem('ethstats-server-url', inputEthStatsServerUrl.value);
                // }

                // let inputEthStatsNodeName = document.getElementById('ethStats-node-name');
                // if (window.localStorage.getItem('ethstats-node-name') != inputEthStatsNodeName.value) {
                //     window.localStorage.setItem('ethstats-node-name', inputEthStatsNodeName.value);
                // }

                // if (document.activeElement !== inputEthStatsNodeName && jsonData.ethStats?.nodeName != undefined && inputEthStatsNodeName.value == jsonData.ethStats?.nodeName) {
                //     inputEthStatsNodeName.value = jsonData.ethStats.nodeName;
                // }

                console.log(jsonData);
            }

            async function startNode1(btn) {
                btn.disabled = true;

                // const cryptedPassword = btoa(rot13(document.getElementById('node1-keystore-password').value));

                let result = await fetch('/run-miner-node', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                let jsonResult = await result.json();
            }

            async function restartNode1(button) {
                button.disabled = true; // Désactive temporairement le bouton pour éviter les double-cliques
                button.querySelector("span").innerText = "Restarting...";
                
                fetch("/restart-node", {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Erreur lors du redémarrage !");
                        }
                        return response.text();
                    })
                    .then(message => {
                        button.querySelector("span").innerText = "Restart";
                    })
                    .catch(error => {
                        console.error("Erreur :", error);
                        button.querySelector("span").innerText = "Restart";
                    })
                    .finally(() => {
                        button.disabled = false; // Réactive le bouton après l'action
                    });
            }

            async function startEthStats(btn) {
                btn.disabled = true;

                let inputEthStatsServerUrl = document.getElementById('ethStats-server-url');
                let inputEthStatsNodeName = document.getElementById('ethStats-node-name');

                let result = await fetch('/run-ethstats', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ethStatsServerUrl: inputEthStatsServerUrl.value,
                            ethStatsNodeName: inputEthStatsNodeName.value
                        })
                    });
                let jsonResult = await result.json();
            }

            async function stopNode1(btn) {
                btn.disabled = true;
                let result = await fetch('/stop-node', {
                    method: 'POST',
                    headers: {
                        'Access-Code': password,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
            }

            async function stopEthStats(btn) {
                btn.disabled = true;
                let result = await fetch('/ethstats-kill', {
                    method: 'POST',
                    headers: {
                        'Access-Code': password,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
            }

            async function execNode1IpcCommand() {
                const node1IpcInput = document.getElementById('node1-ipc-input');
                const node1ipcLogs = document.getElementById('node1-ipc-logs');
                const value = node1IpcInput.value;

                node1IpcInput.disabled = true;

                let result = await fetch('/node1-ipc-command', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            command: value
                        })
                    });
                let jsonData = await result.json();

                node1IpcInput.value = '';
                node1IpcInput.disabled = false;
                node1IpcInput.focus();
                if (compareIt(node1ipcLogs.innerHTML, jsonData.join('\n'))) {
                    node1ipcLogs.innerHTML = jsonData.join('\n');
                    scrollLogToBottom(node1ipcLogs);
                }
            }

            const isSetup = async () => {
                const response = await fetch('/is-setup', {
                        method: 'GET',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        }
                    });
                const isSetup = await response.text();

                if (isSetup === 'true') {
                    return true;
                }
                return false;
            }

            const main = async () => {

                if (password == undefined) {
                    window.location = '/';
                    return ;
                }

                document.querySelectorAll('.main-content')[0].style.display = '';

                const setup = await isSetup();

                if (setup) {
                    // let inputEthStatsServerUrl = document.getElementById('ethStats-server-url');
                    // if (window.localStorage.getItem('ethstats-server-url') != undefined) {
                    //     inputEthStatsServerUrl.value = window.localStorage.getItem('ethstats-server-url');
                    // }
                    // let inputEthStatsNodeName = document.getElementById('ethStats-node-name');
                    // if (window.localStorage.getItem('ethstats-node-name') != undefined) {
                    //     inputEthStatsNodeName.value = window.localStorage.getItem('ethstats-node-name');
                    // }
                    
                    setInterval(async () => {
                        let result = await fetch('/test', {
                            method: 'GET',
                            headers: {
                                'Access-Code': password
                            }
                        });
                        let jsonResult = await result.json();
                        await updateDisplay(jsonResult);
                        // document.getElementById('PageStatus').style.display = 'block';
                    }, 1000 / 1);
                } else {
                    document.getElementById('PageSetup').style.display = 'block';
                }
            }

            window.addEventListener('DOMContentLoaded', async (event) => {
                await main();
            });

        </script>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </body>
</html>